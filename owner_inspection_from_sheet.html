<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Owner Inspection — Year/Month (Sheet-driven)</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%23111827'/%3E%3Cpath fill='%23FFD166' d='M14 42h36v6H14zM18 16h28a6 6 0 016 6v14H12V22a6 6 0 016-6z'/%3E%3Ccircle cx='22' cy='25' r='3' fill='%2306D6A0'/%3E%3Ccircle cx='32' cy='25' r='3' fill='%23FFD166'/%3E%3Ccircle cx='42' cy='25' r='3' fill='%23EF476F'/%3E%3C/svg%3E"/>
<style>
:root{--bg:#fff;--ink:#111827;--muted:#6B7280;--line:#E5E7EB;--ok:#287271;--bad:#9B2226;--brand:#1F2937}
*{box-sizing:border-box}html{scroll-behavior:smooth}body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
.wrap{max-width:1200px;margin:0 auto;padding:20px 20px 80px}
.header{display:flex;align-items:center;justify-content:space-between;gap:16px;position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);padding:10px 0;z-index:10}
.h-left{display:flex;align-items:baseline;gap:12px}
.h-title{font-weight:900;font-size:18px;color:var(--brand)}
.h-sub{color:var(--muted);font-size:12px}
.controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
select{border:1px solid var(--line);border-radius:8px;padding:8px 10px;font-size:12px}
.btn{background:#fff;border:1px solid var(--line);border-radius:8px;padding:8px 10px;font-size:12px;color:var(--brand);cursor:pointer}
.status{font-size:12px;color:var(--muted)}
.kpi-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}
.kpi{display:grid;grid-template-columns:110px 1fr;gap:10px;align-items:center;border:1px solid var(--line);border-radius:12px;padding:12px;background:#fff}
.kpi .donut{width:100px;height:100px}
.kpi .info{display:flex;flex-direction:column}
.kpi .label{font-size:12px;color:var(--muted);font-weight:700}
.kpi .value{font-size:20px;font-weight:900}
.tiles{display:grid;grid-template-columns:repeat(5,1fr);gap:14px;margin-top:14px}
.tile{display:flex;flex-direction:column;align-items:center;border:1px solid var(--line);border-radius:12px;padding:12px;background:#fff;text-decoration:none;color:inherit}
.tile .name{font-weight:800;margin-top:6px}
.tile .pill{font-size:11px;margin-top:6px;padding:3px 7px;border-radius:999px;border:1px solid var(--line)}
.pill.ok{background:#ECFDF5;color:#065F46;border-color:#A7F3D0}.pill.bad{background:#FEF2F2;color:#991B1B;border-color:#FECACA}
.pill.na{background:#F3F4F6;color:#374151;border-color:#E5E7EB}
.section{margin:18px 0}.sec-title{font-weight:900;border-left:4px solid #111827;padding-left:10px;margin:6px 0 10px}
.gallery{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.ph{margin:0;border:1px solid var(--line);border-radius:10px;overflow:hidden;background:#fff;position:relative}
.ph img,.ph iframe{width:100%;height:160px;object-fit:cover;display:block;border:0}
.ph figcaption{font-size:11px;color:#6B7280;padding:6px 8px;display:flex;justify-content:space-between;gap:6px}
.cap-left{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cap-right{color:#374151;white-space:nowrap}
.small{font-size:12px;color:var(--muted)}
.donut{width:72px;height:72px}
.tile svg text{font-size:6px;font-weight:800;fill:#111827}
.err{color:#991B1B}
.loading{opacity:0.7}
</style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="h-left">
        <div class="h-title">Owner Inspection — Year / Month</div>
        <div class="h-sub small" id="summaryDate"></div>
      </div>
      <div class="controls">
        <select id="year" title="Year"></select>
        <select id="month" title="Month"></select>
        <button id="applyYM" class="btn">Apply</button>
        <span id="loadStatus" class="status"></span>
      </div>
    </div>

    <section id="tiles" class="tiles"></section>

    <section id="photos" class="section">
      <div class="sec-title">Photos (Selected Year/Month)</div>
      <div id="photoSections"></div>
    </section>
  </div>

<script>
/** ============== CONFIG ============== **/
const CONFIG = {
  // New Google Sheet (ID + GID you provided)
  SHEET_ID: "1i9s5LT_YnhYIZVv7lgBkNSw519eIPfv_MrvV1E9g1fI",
  GID: "2061234818",

  // How to fetch: CSV export from Google Sheets. Make sure the sheet is shared "Anyone with the link (Viewer)"
  // or Published to the web for public pages.
  DATA_URL: (id, gid) => `https://docs.google.com/spreadsheets/d/${id}/export?format=csv&gid=${gid}`,

  // Header aliases. Add/adjust as needed to match your sheet.
  HEADER_ALIASES: {
    timestamp: ["timestamp","date","inspection date","fecha","created at","time stamp"],
    year: ["year","ano","año"],
    month: ["month","mes"],
    section: ["section","area","room","category","seccion","sección"],
    status: ["status","result","pass/fail","pass fail","outcome","estado","ok?","pass","fail","issue"],
    photo: ["photo","photo url","image","image url","foto","picture","photo link","evidence"],
  },

  // Values interpreted as pass/fail.
  PASS_VALUES: ["pass","ok","clear","yes","true","1","correcto","good","right"],
  FAIL_VALUES: ["fail","issue","no","false","0","fix","repair","bad","incorrecto","problem","problems","needs attention"],

  // Sections ordering (optional) — if present, we use this order; other sections follow alphabetically.
  SECTION_ORDER: ["Living","Kitchen","Bedroom","Bathroom","Systems","Lock & Leave"],
};

/** ============== UTILITIES ============== **/
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const statusEl = $("#loadStatus");

function setStatus(msg, isError=false){
  statusEl.textContent = msg || "";
  statusEl.className = "status" + (isError ? " err" : "");
}

function norm(s){ return String(s||"").trim(); }
function slug(s){ return norm(s).toLowerCase().replace(/[^a-z0-9]+/g," "); }
function toNum(v){ const n = Number(v); return Number.isFinite(n)? n : null; }

function parseMonthOrName(v){
  const n = parseInt(v,10);
  if(Number.isFinite(n) && n>=1 && n<=12) return n;
  // Try text month
  const name = slug(v);
  const months = "january february march april may june july august september october november december".split(" ");
  const idx = months.findIndex(m => name.startsWith(m.slice(0,3)));
  return idx>=0 ? (idx+1) : null;
}

function monthName(m){
  return new Date(2000, m-1, 1).toLocaleString(undefined,{month:"long"});
}

/** CSV parser that handles quotes and commas **/
function parseCSV(text){
  const rows = [];
  let i=0, field="", row=[], inQuotes=false;
  while(i<text.length){
    const c=text[i];
    if(inQuotes){
      if(c==='\"'){
        if(text[i+1]==='\"'){ field+='\"'; i++; }
        else { inQuotes=false; }
      } else {
        field+=c;
      }
    } else {
      if(c==='\"'){ inQuotes=true; }
      else if(c===','){ row.push(field); field=""; }
      else if(c==='\n'){ row.push(field); rows.push(row); field=""; row=[]; }
      else if(c==='\r'){ /* ignore */ }
      else { field+=c; }
    }
    i++;
  }
  // trailing
  if(field.length || row.length){ row.push(field); rows.push(row); }
  return rows;
}

function pickHeaderIndex(headers, aliases){
  const map = {};
  headers.forEach((h,idx)=>{
    const ns = slug(h);
    for(const key in aliases){
      const list = aliases[key];
      if(list.some(a => ns === slug(a) || ns.includes(slug(a)))){
        map[key] = idx;
      }
    }
  });
  return map;
}

function datePartsFromAny(v){
  const dt = new Date(v);
  if(!isNaN(dt)) return { y: dt.getFullYear(), m: dt.getMonth()+1, ts: dt.toISOString() };
  // Try YYYY-MM or YYYY/MM etc
  const s = norm(v);
  const m1 = s.match(/(\d{4})[-\/](\d{1,2})/);
  if(m1){ return { y: +m1[1], m: +m1[2], ts: new Date(+m1[1], +m1[2]-1, 1).toISOString() }; }
  // Try "Aug 2025" style
  const m2 = s.match(/([A-Za-z]{3,})\s+(\d{4})/);
  if(m2){
    const mm = parseMonthOrName(m2[1]) || 1;
    const yy = +m2[2];
    return { y: yy, m: mm, ts: new Date(yy, mm-1, 1).toISOString() };
  }
  return { y:null, m:null, ts:null };
}

function isPass(v){
  const x = slug(v);
  return CONFIG.PASS_VALUES.some(p => x.includes(slug(p)));
}
function isFail(v){
  const x = slug(v);
  return CONFIG.FAIL_VALUES.some(p => x.includes(slug(p)));
}

function toDrivePreview(u){
  try{
    if(!u.includes('drive.google.com')) return null;
    const m = u.match(/\/file\/d\/([^/]+)\//);
    let id = m ? m[1] : null;
    if(!id){
      const url = new URL(u);
      id = url.searchParams.get('id');
    }
    return id ? ('https://drive.google.com/file/d/'+id+'/preview') : null;
  }catch(e){ return null; }
}

/** ============== DATA INGEST ============== **/
async function loadSheet(){
  const url = CONFIG.DATA_URL(CONFIG.SHEET_ID, CONFIG.GID);
  setStatus("Loading data…");
  const res = await fetch(url);
  if(!res.ok){ throw new Error(`Fetch failed (${res.status})`); }
  const csv = await res.text();
  const rows = parseCSV(csv);
  if(!rows.length) throw new Error("Empty sheet");
  const headers = rows[0].map(h=>norm(h));
  const idxMap = pickHeaderIndex(headers, CONFIG.HEADER_ALIASES);

  // Required: section + (status or pass/fail signal) and some date parts.
  if(idxMap.section===undefined) throw new Error("Couldn't find a 'section' column — please add alias in HEADER_ALIASES.");
  if(idxMap.status===undefined && idxMap.photo===undefined) {
    // We at least need status or photos to compute something useful
    throw new Error("Couldn't find a 'status' or 'photo' column — please add alias in HEADER_ALIASES.");
  }

  const out = []; // {year, month, sections:{...}, overall:{...}, photos:{...}, timestamp}
  const perYM = new Map(); // key "y-m" => struct

  function getBucket(y,m){
    const key = `${y}-${m}`;
    if(!perYM.has(key)){
      perYM.set(key, {
        year:y, month:m, timestamp:new Date(y, m-1, 1).toISOString(),
        sections: {}, photos: {}, overall: {total:0, passes:0, fails:0, rate:0}
      });
    }
    return perYM.get(key);
  }

  // Iterate rows
  for(let r=1;r<rows.length;r++){
    const row = rows[r];
    if(row.every(v => norm(v)==="")) continue; // skip empties

    // SECTION
    const section = norm(row[idxMap.section] || "Other") || "Other";

    // STATUS
    const statusVal = idxMap.status!==undefined ? norm(row[idxMap.status]) : "";

    // PHOTO
    const photoURL = idxMap.photo!==undefined ? norm(row[idxMap.photo]) : "";

    // DATE PARTS
    let Y=null, M=null, TS=null;
    if(idxMap.year!==undefined) Y = toNum(row[idxMap.year]);
    if(idxMap.month!==undefined) M = parseMonthOrName(row[idxMap.month]);
    if((idxMap.timestamp!==undefined) && (!Y || !M)){
      const d = datePartsFromAny(row[idxMap.timestamp]);
      Y = Y || d.y; M = M || d.m; TS = d.ts;
    }
    if(!Y || !M){
      // If we STILL don't have Y/M, try headers called "date"/"fecha"
      if(idxMap.timestamp===undefined){
        // Look for a column literally named like date
        const dateIdx = headers.findIndex(h=>/date|fecha/i.test(h));
        if(dateIdx>=0){
          const d = datePartsFromAny(row[dateIdx]);
          Y = Y || d.y; M = M || d.m; TS = d.ts;
        }
      }
    }
    if(!Y || !M) continue; // can't place this row on a timeline

    const bkt = getBucket(Y,M);
    // init section counters
    if(!bkt.sections[section]) bkt.sections[section] = { total:0, passes:0, fails:0 };
    bkt.sections[section].total++;

    if(statusVal){
      if(isPass(statusVal)) { bkt.sections[section].passes++; bkt.overall.passes++; bkt.overall.total++; }
      else if(isFail(statusVal)) { bkt.sections[section].fails++; bkt.overall.fails++; bkt.overall.total++; }
      else {
        // Unknown status: count toward total only
        bkt.overall.total++;
      }
    } else {
      // no status — don't affect pass/fail, but still consider as an item
      bkt.overall.total++;
    }

    if(photoURL){
      if(!bkt.photos[section]) bkt.photos[section] = [];
      bkt.photos[section].push({ url: photoURL, ts: TS || new Date(Y, M-1, 1).toISOString() });
    }
  }

  // finalize
  for(const b of perYM.values()){
    b.overall.rate = b.overall.total ? (b.overall.passes / b.overall.total * 100) : 0;
    out.push(b);
  }
  // Sort by y/m
  out.sort((a,b)=> a.year!==b.year ? a.year-b.year : a.month-b.month);

  return out;
}

/** ============== AGG + RENDER (same visuals as your prior file) ============== **/
function aggregate(rows){
  const agg={overall:{total:0,passes:0,fails:0}, sections:{}, photos:{}};
  rows.forEach(r=>{
    agg.overall.total += r.overall.total;
    agg.overall.passes += r.overall.passes;
    agg.overall.fails += r.overall.fails;
    for(const [sec,v] of Object.entries(r.sections)){
      if(!agg.sections[sec]) agg.sections[sec]={total:0,passes:0,fails:0};
      agg.sections[sec].total+=v.total; agg.sections[sec].passes+=v.passes; agg.sections[sec].fails+=v.fails;
    }
    for(const [sec,items] of Object.entries(r.photos||{})){
      if(!agg.photos[sec]) agg.photos[sec]=[];
      agg.photos[sec].push(...items);
    }
  });
  agg.overall.rate = agg.overall.total? (agg.overall.passes/agg.overall.total*100):0;
  return agg;
}

function renderTiles(agg){
  const tiles=document.getElementById('tiles');
  tiles.innerHTML='';
  let secs=Object.keys(agg.sections);

  // preferred order first
  const order = CONFIG.SECTION_ORDER || [];
  secs.sort((a,b)=>{
    const ia = order.indexOf(a), ib = order.indexOf(b);
    if(ia>=0 && ib>=0) return ia-ib;
    if(ia>=0) return -1;
    if(ib>=0) return 1;
    return a.localeCompare(b);
  });

  secs.forEach(sec=>{
    const s=agg.sections[sec];
    const total = s.total || 0;
    const passes = s.passes || 0;
    const fails  = s.fails  || 0;
    const rate = total ? Math.round((passes/total)*100) : null; // null => No Data
    const pill = total === 0
      ? '<span class="pill na">No data</span>'
      : (fails>0 ? '<span class="pill bad">'+fails+' issue'+(fails>1?'s':'')+'</span>' : '<span class="pill ok">Clear</span>');
    const dash = rate===null ? '0,100' : rate+','+(100-rate);
    const center = rate===null ? 'No Data' : (rate+'%');

    const tile=document.createElement('a'); tile.className='tile'; tile.href='#sec-'+sec.replace(/\s+/g,'-').toLowerCase();
    tile.innerHTML=`
      <svg class="donut" viewBox="0 0 36 36">
        <circle cx="18" cy="18" r="15.915" fill="none" stroke="#EAEFF5" stroke-width="3.8"></circle>
        <circle cx="18" cy="18" r="15.915" fill="none" stroke="#7A6C5D" stroke-width="3.8" stroke-linecap="round" stroke-dasharray="${dash}"></circle>
        <text x="18" y="20" text-anchor="middle">${center}</text>
      </svg>
      <div class="name">${sec}</div>
      ${pill}`;
    tiles.appendChild(tile);
  });
}

function renderPhotos(agg){
  const wrap=document.getElementById('photoSections');
  wrap.innerHTML='';
  const secs=Object.keys(agg.photos).sort();
  secs.forEach(sec=>{
    const id='sec-'+sec.replace(/\s+/g,'-').toLowerCase();
    const secDiv=document.createElement('div'); secDiv.className='section'; secDiv.id=id;
    secDiv.innerHTML=`<div class="sec-title">${sec}</div>`;
    const g=document.createElement('div'); g.className='gallery';
    (agg.photos[sec]||[]).slice(0,120).forEach(item=>{
      const url = item.url, ts = item.ts;
      const fig=document.createElement('figure'); fig.className='ph';
      const img=document.createElement('img'); img.alt=sec+' photo'; img.loading='lazy'; img.referrerPolicy='no-referrer'; img.src=url;
      img.onerror=()=>{
        const preview = toDrivePreview(url);
        if(preview){
          const ifr = document.createElement('iframe'); ifr.loading='lazy'; ifr.src=preview; fig.appendChild(ifr);
          img.remove();
        } else {
          const a=document.createElement('a'); a.href=url; a.target='_blank'; a.textContent='Open Photo'; img.replaceWith(a);
        }
      };
      const cap=document.createElement('figcaption');
      const left=document.createElement('span'); left.className='cap-left'; left.textContent=sec;
      const right=document.createElement('span'); right.className='cap-right'; right.textContent = ts ? new Date(ts).toLocaleString() : "";
      cap.appendChild(left); cap.appendChild(right);
      fig.appendChild(img); fig.appendChild(cap); g.appendChild(fig);
    });
    secDiv.appendChild(g); wrap.appendChild(secDiv);
  });
}

/** ============== YEAR/MONTH FILTERING UI ============== **/
let DATA = [];
let YEARS = [];
let MONTHS_BY_YEAR = {};

function applyYearMonth(){
  const y = parseInt(document.getElementById('year').value,10);
  const m = parseInt(document.getElementById('month').value,10);
  const rows = DATA.filter(r=> r.year===y && r.month===m);
  const agg = aggregate(rows);
  // Header date label
  const label = rows.length ? new Date(rows[rows.length-1].timestamp).toLocaleString(undefined,{year:'numeric',month:'long'}) : 'No data';
  document.getElementById('summaryDate').textContent = label;
  // Render
  renderTiles(agg);
  renderPhotos(agg);
}

function populateYearMonth(){
  const ySel = document.getElementById('year');
  const mSel = document.getElementById('month');
  ySel.innerHTML='';
  YEARS.forEach(y=>{
    const opt=document.createElement('option'); opt.value=y; opt.textContent=y; ySel.appendChild(opt);
  });
  ySel.value = YEARS[YEARS.length-1];
  function fillMonths(y){
    mSel.innerHTML='';
    const months = (MONTHS_BY_YEAR[String(y)] || []).sort((a,b)=>a-b);
    months.forEach(m=>{
      const opt=document.createElement('option');
      opt.value=m;
      const name=new Date(2000,m-1,1).toLocaleString(undefined,{month:'long'});
      opt.textContent=name;
      mSel.appendChild(opt);
    });
    if(months.length){ mSel.value = months[months.length-1]; }
  }
  fillMonths(ySel.value);
  ySel.addEventListener('change', ()=>{ fillMonths(ySel.value); applyYearMonth(); });
  mSel.addEventListener('change', applyYearMonth);
}

function rebuildYearMonthIndex(){
  const setY = new Set();
  const mapYM = {};
  DATA.forEach(r=>{
    setY.add(r.year);
    if(!mapYM[r.year]) mapYM[r.year] = new Set();
    mapYM[r.year].add(r.month);
  });
  YEARS = Array.from(setY).sort((a,b)=>a-b);
  MONTHS_BY_YEAR = {};
  for(const y of YEARS){
    MONTHS_BY_YEAR[String(y)] = Array.from(mapYM[y]||[]).sort((a,b)=>a-b);
  }
}

/** ============== INIT ============== **/
document.getElementById('applyYM').addEventListener('click', applyYearMonth);

(async function init(){
  try{
    setStatus("Loading…");
    document.body.classList.add("loading");
    const rows = await loadSheet();
    DATA = rows;
    rebuildYearMonthIndex();
    populateYearMonth();
    applyYearMonth();
    setStatus(`Loaded ${rows.length} month(s) from sheet.`);
  }catch(err){
    console.error(err);
    setStatus(err.message || "Failed to load.", true);
  }finally{
    document.body.classList.remove("loading");
  }
})();

</script>
</body>
</html>
