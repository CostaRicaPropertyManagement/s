<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Venturebnb — Property List</title>
  <!-- Tailwind (via CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PapaParse for robust CSV parsing -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <meta name="description" content="Auto-updating view of the Venturebnb Property List from a published Google Sheets CSV." />
</head>
<body class="bg-slate-50 text-slate-800">
  <main class="max-w-7xl mx-auto p-6">
    <header class="mb-6 flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between">
      <div>
        <h1 class="text-2xl sm:text-3xl font-semibold tracking-tight">Venturebnb — Property List</h1>
        <p class="text-sm text-slate-500">Live from your published Google Sheets CSV. Loads on page open and on demand.</p>
      </div>
      <div class="flex items-center gap-2">
        <a id="downloadLink" href="#" target="_blank" class="inline-flex items-center gap-2 rounded-xl border border-slate-300 px-3 py-2 text-sm hover:bg-white shadow-sm">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M7.5 12l4.5 4.5m0 0L16.5 12m-4.5 4.5V3"/></svg>
          Download CSV
        </a>
        <button id="refreshBtn" class="inline-flex items-center gap-2 rounded-xl bg-slate-900 text-white px-3 py-2 text-sm hover:bg-black focus:outline-none focus:ring-2 focus:ring-slate-400">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992m0 0V4.356m0 4.992l-3.181-3.181A8.25 8.25 0 103.75 12.75"/></svg>
          Refresh
        </button>
      </div>
    </header>

    <section class="mb-4 grid gap-3 sm:grid-cols-3">
      <div class="sm:col-span-2">
        <label for="search" class="block text-xs font-medium text-slate-600">Search</label>
        <input id="search" type="text" placeholder="Filter rows…" class="mt-1 w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-slate-400" />
      </div>
      <div class="grid grid-cols-2 gap-3 sm:grid-cols-1">
        <div>
          <p class="text-xs text-slate-500">Last updated</p>
          <p id="lastUpdated" class="text-sm">—</p>
        </div>
        <div>
          <p class="text-xs text-slate-500">Rows</p>
          <p id="rowCount" class="text-sm">0</p>
        </div>
      </div>
    </section>

    <section id="status" class="mb-3 hidden">
      <div class="rounded-xl border border-amber-300 bg-amber-50 p-3 text-amber-800 text-sm">
        Loading…
      </div>
    </section>

    <section class="overflow-auto rounded-2xl border border-slate-200 bg-white shadow-sm">
      <table id="dataTable" class="min-w-full text-left text-sm">
        <thead class="bg-slate-100 text-slate-700 sticky top-0 z-10">
          <tr id="theadRow"></tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
      <div id="emptyState" class="hidden p-6 text-center text-slate-500">No data to display.</div>
    </section>

    <footer class="mt-6 text-xs text-slate-500">
      <p>Source: Published Google Sheets CSV.</p>
    </footer>
  </main>

  <script>
    // ⚠️ The only thing you usually need to change is this URL.
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTlbdTFUi--YkOJkuO974DuxPNGcxXWIowUzUrSzuTqwPJGsD9ybHJGZqsZuDt2bZ9-FiGyeg77bNXV/pub?gid=2061234818&single=true&output=csv";

    const els = {
      downloadLink: document.getElementById('downloadLink'),
      refreshBtn: document.getElementById('refreshBtn'),
      lastUpdated: document.getElementById('lastUpdated'),
      rowCount: document.getElementById('rowCount'),
      search: document.getElementById('search'),
      theadRow: document.getElementById('theadRow'),
      tbody: document.getElementById('tbody'),
      emptyState: document.getElementById('emptyState'),
      status: document.getElementById('status'),
      table: document.getElementById('dataTable'),
    };

    let fullData = [];
    let displayData = [];

    function setStatus(msg = "Loading…") {
      els.status.querySelector('div').textContent = msg;
      els.status.classList.remove('hidden');
    }
    function clearStatus() { els.status.classList.add('hidden'); }

    function formatDate(d) {
      try {
        return new Intl.DateTimeFormat(undefined, { dateStyle: 'medium', timeStyle: 'short' }).format(d);
      } catch {
        return d.toLocaleString();
      }
    }

    function cacheBustedUrl(url) {
      const u = new URL(url);
      u.searchParams.set('_', String(Date.now()));
      return u.toString();
    }

    function renderTable(data) {
      // Headers
      els.theadRow.innerHTML = '';
      els.tbody.innerHTML = '';

      if (!data || data.length === 0) {
        els.emptyState.classList.remove('hidden');
        els.rowCount.textContent = '0';
        return;
      }
      els.emptyState.classList.add('hidden');

      const cols = Object.keys(data[0] || {});
      for (const key of cols) {
        const th = document.createElement('th');
        th.className = 'px-3 py-2 whitespace-nowrap font-medium';
        th.textContent = key;
        els.theadRow.appendChild(th);
      }

      const frag = document.createDocumentFragment();
      for (const row of data) {
        const tr = document.createElement('tr');
        tr.className = 'border-t border-slate-100 hover:bg-slate-50';
        for (const key of cols) {
          const td = document.createElement('td');
          td.className = 'px-3 py-2 align-top';
          let val = row[key];
          // Auto-link URLs
          if (typeof val === 'string' && /^https?:\/\//i.test(val)) {
            const a = document.createElement('a');
            a.href = val; a.target = '_blank'; a.rel = 'noopener';
            a.className = 'underline';
            a.textContent = val;
            td.appendChild(a);
          } else {
            td.textContent = val == null ? '' : String(val);
          }
          tr.appendChild(td);
        }
        frag.appendChild(tr);
      }
      els.tbody.appendChild(frag);
      els.rowCount.textContent = String(data.length);
    }

    function applyFilter() {
      const q = els.search.value.trim().toLowerCase();
      if (!q) {
        displayData = fullData.slice();
      } else {
        displayData = fullData.filter(row =>
          Object.values(row).some(v => String(v ?? '').toLowerCase().includes(q))
        );
      }
      renderTable(displayData);
    }

    async function loadCsv({ bustCache = false } = {}) {
      try {
        setStatus('Loading…');
        const url = bustCache ? cacheBustedUrl(CSV_URL) : CSV_URL;
        els.downloadLink.href = CSV_URL;

        // Use Papa to parse streamed CSV
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const csvText = await res.text();
        const parsed = Papa.parse(csvText, { header: true, dynamicTyping: true, skipEmptyLines: true });
        if (parsed.errors && parsed.errors.length) {
          console.warn('CSV parse warnings:', parsed.errors.slice(0,3));
        }
        fullData = Array.isArray(parsed.data) ? parsed.data : [];
        displayData = fullData.slice();
        renderTable(displayData);
        els.lastUpdated.textContent = formatDate(new Date());
      } catch (err) {
        console.error(err);
        els.theadRow.innerHTML = '';
        els.tbody.innerHTML = '';
        els.emptyState.classList.remove('hidden');
        els.emptyState.textContent = 'Failed to load data. Check the CSV link or network and try again.';
      } finally {
        clearStatus();
      }
    }

    // Events
    els.search.addEventListener('input', applyFilter);
    els.refreshBtn.addEventListener('click', () => loadCsv({ bustCache: true }));

    // Init
    loadCsv();
  </script>
</body>
</html>
