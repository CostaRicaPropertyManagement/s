<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Owner Inspection — Live CSV</title>
<style>
:root{--bg:#fff;--ink:#111827;--muted:#6B7280;--line:#E5E7EB;--ok:#287271;--bad:#9B2226;--brand:#1F2937}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,ui-sans-serif}
.wrap{max-width:1200px;margin:0 auto;padding:20px}
.header{display:flex;flex-wrap:wrap;align-items:center;gap:12px;position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);padding:10px 0;z-index:10}
.h-title{font-weight:900;font-size:18px;color:var(--brand)}
.h-sub{color:var(--muted);font-size:12px}
.controls{display:flex;flex-wrap:wrap;gap:8px}
select,input,button{border:1px solid var(--line);border-radius:8px;padding:8px 10px;font-size:12px}
.btn{background:#fff;color:var(--brand);cursor:pointer}
.tiles{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:14px;margin-top:14px}
.tile{display:flex;flex-direction:column;align-items:center;border:1px solid var(--line);border-radius:12px;padding:12px;background:#fff;text-decoration:none;color:inherit}
.tile .name{font-weight:800;margin-top:6px}
.tile .pill{font-size:11px;margin-top:6px;padding:3px 7px;border-radius:999px;border:1px solid var(--line)}
.pill.ok{background:#ECFDF5;color:#065F46;border-color:#A7F3D0}
.pill.bad{background:#FEF2F2;color:#991B1B;border-color:#FECACA}
.pill.na{background:#F3F4F6;color:#374151;border-color:#E5E7EB}
.section{margin:18px 0}
.sec-title{font-weight:900;border-left:4px solid var(--brand);padding-left:10px;margin:6px 0 10px}
.gallery{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:8px}
.ph{margin:0;border:1px solid var(--line);border-radius:10px;overflow:hidden;background:#fff;position:relative}
.ph img,.ph iframe{width:100%;height:160px;object-fit:cover;display:block;border:0}
.ph figcaption{font-size:11px;color:#6B7280;padding:6px 8px;display:flex;justify-content:space-between;gap:6px}
.cap-left{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cap-right{color:#374151;white-space:nowrap}
.small{font-size:12px;color:var(--muted)}
.donut{width:72px;height:72px}
.tile svg text{font-size:6px;font-weight:800;fill:#111827}
</style>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div>
      <div class="h-title">Owner Inspection — Year / Month</div>
      <div class="h-sub small" id="summaryDate"></div>
    </div>
    <div class="controls">
      <select id="year"></select>
      <select id="month"></select>
      <button id="lastBtn" class="btn">Last Inspection</button>
      <button id="applyYM" class="btn">Apply</button>
    </div>
  </div>
  <div id="errBox" class="small" style="margin-top:8px;color:#9B2226;"></div>
  <section id="tiles" class="tiles"></section>
  <section class="section">
    <div class="sec-title">Photos (Selected Year/Month)</div>
    <div id="photoSections"></div>
  </section>
</div>
<script>
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTH18JY92PQUibhQfTwhTcJZpEEuz-NrBbe4fUWAB0lSCT2tY-X9GwIVEQhr8XCHEH08EHfq3vav1Td/pub?output=csv';

let RAW_ROWS = [], YEARS = [], MONTHS_BY_YEAR = {}, LATEST_YM = {year:undefined,month:undefined};
const META_KEYS = new Set(['year','Year','YEAR','month','Month','MONTH','timestamp','Timestamp','TS','ts','section','Section','SECTION','passes','pass','Passes','PASS','PASSes','fails','fail','Fails','FAIL','total','Total','TOTAL','photo_url','photo','Photo','URL','url','photo ts','photo_ts']);

function setError(msg){document.getElementById('errBox').textContent = msg||'';}
function toNum(v){const n = Number(v);return Number.isFinite(n)?n:0;}
function firstDefined(...xs){return xs.find(x=>x!==undefined && x!==null && String(x).trim()!=="");}
function deriveYearMonth(r){
  const y = r.year ?? r.Year ?? r.YEAR;
  const m = r.month ?? r.Month ?? r.MONTH;
  if (y && m) return {year:+y,month:+m};
  const t = firstDefined(r.timestamp,r.Timestamp,r.ts,r.TS,r.photo_ts,r['photo ts']);
  const d = t?new Date(t):null;
  return d&&!isNaN(d)?{year:d.getFullYear(),month:d.getMonth()+1}:{year:undefined,month:undefined};
}
function computeYNCounts(r){
  let pass=0,fail=0;
  for(const [k,v] of Object.entries(r)){
    if(META_KEYS.has(k)) continue;
    if(v==null) continue;
    const raw=String(v).trim();
    if(!raw) continue;
    if(raw.includes('http://')||raw.includes('https://')) continue;
    const lc=raw.toLowerCase();
    if(lc==='yes'||lc==='sí'||lc==='si'){pass++;continue;}
    if(lc==='no'){fail++;continue;}
  }
  return {passes:pass,fails:fail,total:pass+fail};
}
function aggregateFromRows(rows){
  const agg={overall:{total:0,passes:0,fails:0,rate:0},sections:{},photos:{}};
  rows.forEach(r=>{
    const section=firstDefined(r.section,r.Section,r.SECTION);
    let passes=toNum(firstDefined(r.passes,r.Passes,r.PASS,r.PASSes));
    let fails=toNum(firstDefined(r.fails,r.Fails,r.FAIL));
    let total=toNum(firstDefined(r.total,r.Total,r.TOTAL));
    if((passes+fails)===0 && total===0){
      const c=computeYNCounts(r);passes=c.passes;fails=c.fails;total=c.total;
    }
    if(!total) total=passes+fails;
    if(section){
      if(!agg.sections[section]) agg.sections[section]={total:0,passes:0,fails:0};
      agg.sections[section].total+=total;
      agg.sections[section].passes+=passes;
      agg.sections[section].fails+=fails;
    }
    agg.overall.total+=total;agg.overall.passes+=passes;agg.overall.fails+=fails;
    const purl=firstDefined(r.photo_url,r.photo,r.url,r.Photo,r.URL);
    const pts=firstDefined(r.photo_ts,r['photo ts'],r.timestamp,r.ts,r.Timestamp,r.TS)||new Date().toISOString();
    if(purl&&section){
      if(!agg.photos[section]) agg.photos[section]=[];
      agg.photos[section].push({url:purl,ts:pts});
    }
  });
  agg.overall.rate=agg.overall.total?(agg.overall.passes/agg.overall.total*100):0;
  return agg;
}
function renderTiles(agg){
  const tiles=document.getElementById('tiles');tiles.innerHTML='';
  Object.keys(agg.sections).sort().forEach(sec=>{
    const s=agg.sections[sec];
    const total=s.total||0,passes=s.passes||0,fails=s.fails||0;
    const rate=total?Math.round((passes/total)*100):null;
    const pill=total===0?'<span class="pill na">No data</span>':(fails>0?`<span class="pill bad">${fails} issue${fails>1?'s':''}</span>`:'<span class="pill ok">Clear</span>');
    const dash=rate===null?'0,100':rate+','+(100-rate);
    const center=rate===null?'No Data':(rate+'%');
    const tile=document.createElement('a');tile.className='tile';tile.href='#sec-'+sec.replace(/\\s+/g,'-').toLowerCase();
    tile.innerHTML=`<svg class="donut" viewBox="0 0 36 36"><circle cx="18" cy="18" r="15.915" fill="none" stroke="#EAEFF5" stroke-width="3.8"></circle><circle cx="18" cy="18" r="15.915" fill="none" stroke="#7A6C5D" stroke-width="3.8" stroke-linecap="round" stroke-dasharray="${dash}"></circle><text x="18" y="20" text-anchor="middle">${center}</text></svg><div class="name">${sec}</div>${pill}`;
    tiles.appendChild(tile);
  });
}
function toDrivePreview(u){
  try{
    if(!u.includes('drive.google.com')) return null;
    const m=u.match(/\\/file\\/d\\/([^/]+)\\//);
    let id=m?m[1]:null;
    if(!id){const url=new URL(u);id=url.searchParams.get('id');}
    return id?('https://drive.google.com/file/d/'+id+'/preview'):null;
  }catch(e){return null;}
}
function renderPhotos(agg){
  const wrap=document.getElementById('photoSections');wrap.innerHTML='';
  Object.keys(agg.photos).sort().forEach(sec=>{
    const id='sec-'+sec.replace(/\\s+/g,'-').toLowerCase();
    const secDiv=document.createElement('div');secDiv.className='section';secDiv.id=id;
    secDiv.innerHTML=`<div class="sec-title">${sec}</div>`;
    const g=document.createElement('div');g.className='gallery';
    agg.photos[sec].slice(0,60).forEach(item=>{
      const fig=document.createElement('figure');fig.className='ph';
      const img=document.createElement('img');img.alt=sec+' photo';img.loading='lazy';img.referrerPolicy='no-referrer';img.src=item.url;
      img.onerror=()=>{
        const preview=toDrivePreview(item.url);
        if(preview){const ifr=document.createElement('iframe');ifr.loading='lazy';ifr.src=preview;fig.appendChild(ifr);img.remove();}
        else{const a=document.createElement('a');a.href=item.url;a.target='_blank';a.textContent='Open Photo';img.replaceWith(a);}
      };
      const cap=document.createElement('figcaption');
      const left=document.createElement('span');left.className='cap-left';left.textContent=sec;
      const right=document.createElement('span');right.className='cap-right';right.textContent=(new Date(item.ts)).toLocaleString();
      cap.appendChild(left);cap.appendChild(right);
      fig.appendChild(img);fig.appendChild(cap);g.appendChild(fig);
    });
    secDiv.appendChild(g);wrap.appendChild(secDiv);
  });
}
function populateSelectors(){
  const ySel=document.getElementById('year'),mSel=document.getElementById('month');
  ySel.innerHTML='';YEARS.forEach(y=>{const opt=document.createElement('option');opt.value=y;opt.textContent=y;ySel.appendChild(opt);});
  if(YEARS.length) ySel.value=YEARS[YEARS.length-1];
  function fillMonths(y){
    mSel.innerHTML='';
    (MONTHS_BY_YEAR[String(y)]||[]).sort((a,b)=>a-b).forEach(m=>{const opt=document.createElement('option');opt.value=m;opt.textContent=new Date(2000,m-1,1).toLocaleString(undefined,{month:'long'});mSel.appendChild(opt);});
    if(mSel.options.length) mSel.value=mSel.options[mSel.options.length-1].value;
  }
  fillMonths(ySel.value);
  ySel.onchange=()=>{fillMonths(ySel.value);applyYearMonth();};
  mSel.onchange=applyYearMonth;
}
function applyYearMonth(){
  const y=+document.getElementById('year').value,m=+document.getElementById('month').value;
  const rows=RAW_ROWS.filter(r=>{const d=deriveYearMonth(r);return d.year===y&&d.month===m;});
  const agg=aggregateFromRows(rows);
  document.getElementById('summaryDate').textContent=rows.length?new Date(y,m-1,1).toLocaleString(undefined,{year:'numeric',month:'long'}):'No data';
  renderTiles(agg);renderPhotos(agg);
}
function jumpToLast(){if(!LATEST_YM.year)return;document.getElementById('year').value=LATEST_YM.year;document.getElementById('month').value=LATEST_YM.month;applyYearMonth();}
async function fetchCSVRows(){
  const res=await fetch(CSV_URL+'&_ts_='+Date.now(),{cache:'no-store'});
  if(!res.ok) throw new Error('HTTP '+res.status);
  const text=await res.text();
  const parsed=Papa.parse(text,{header:true,skipEmptyLines:true});
  return parsed.data;
}
function buildIndex(rows){
  const years=new Set(),map={},latest={ts:0};
  rows.forEach(r=>{
    const {year,month}=deriveYearMonth(r);
    if(!year||!month) return;
    years.add(year);if(!map[year]) map[year]=new Set();map[year].add(month);
    const tStr=firstDefined(r.timestamp,r.Timestamp,r.ts,r.TS,r.photo_ts,r['photo ts']);
    const t=tStr?Date.parse(tStr):Date.parse(`${year}-${String(month).padStart(2,'0')}-01`);
    if(t>latest.ts) latest.year=year,latest.month=month,latest.ts=t;
  });
  YEARS=[...years].sort((a,b)=>a-b);
  MONTHS_BY_YEAR={};Object.entries(map).forEach(([y,set])=>MONTHS_BY_YEAR[y]=[...set].sort((a,b)=>a-b));
  LATEST_YM={year:latest.year,month:latest.month};
}
async function loadAndRender(){
  setError('');document.getElementById('summaryDate').textContent='Loading…';
  try{RAW_ROWS=await fetchCSVRows();buildIndex(RAW_ROWS);populateSelectors();applyYearMonth();}
  catch(e){console.error(e);setError(e.message);}
}
document.getElementById('applyYM').onclick=applyYearMonth;
document.getElementById('lastBtn').onclick=jumpToLast;
loadAndRender();
</script>
</body>
</html>
