<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Owner Inspection — Live CSV</title>
<style>
:root{--bg:#fff;--ink:#111827;--muted:#6B7280;--line:#E5E7EB;--ok:#287271;--bad:#9B2226;--brand:#1F2937}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
.wrap{max-width:1200px;margin:0 auto;padding:20px}
.header{display:flex;flex-wrap:wrap;align-items:center;gap:12px;position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);padding:10px 0;z-index:10}
.h-title{font-weight:900;font-size:18px;color:var(--brand)}
.h-sub{color:var(--muted);font-size:12px}
.controls{display:flex;flex-wrap:wrap;gap:8px}
select,input,button{border:1px solid var(--line);border-radius:8px;padding:8px 10px;font-size:12px}
.btn{background:#fff;color:var(--brand);cursor:pointer}
.tiles{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:14px;margin-top:14px}
.tile{display:flex;flex-direction:column;align-items:center;border:1px solid var(--line);border-radius:12px;padding:12px;background:#fff;text-decoration:none;color:inherit}
.tile .name{font-weight:800;margin-top:6px;text-align:center}
.tile .pill{font-size:11px;margin-top:6px;padding:3px 7px;border-radius:999px;border:1px solid var(--line)}
.pill.ok{background:#ECFDF5;color:#065F46;border-color:#A7F3D0}
.pill.bad{background:#FEF2F2;color:#991B1B;border-color:#FECACA}
.pill.na{background:#F3F4F6;color:#374151;border-color:#E5E7EB}
.section{margin:18px 0}
.sec-title{font-weight:900;border-left:4px solid var(--brand);padding-left:10px;margin:6px 0 10px}
.gallery{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:8px}
.ph{margin:0;border:1px solid var(--line);border-radius:10px;overflow:hidden;background:#fff;position:relative}
.ph img,.ph iframe{width:100%;height:160px;object-fit:cover;display:block;border:0}
.ph figcaption{font-size:11px;color:#6B7280;padding:6px 8px;display:flex;justify-content:space-between;gap:6px}
.cap-left{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cap-right{color:#374151;white-space:nowrap}
.small{font-size:12px;color:var(--muted)}
.donut{width:72px;height:72px}
.tile svg text{font-size:6px;font-weight:800;fill:#111827}
</style>
<!-- Papa Parse for robust CSV parsing -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div>
      <div class="h-title">Owner Inspection — Year / Month</div>
      <div class="h-sub small" id="summaryDate"></div>
    </div>
    <div class="controls">
      <select id="year" title="Year"></select>
      <select id="month" title="Month"></select>
      <button id="lastBtn" class="btn" title="Jump to most recent inspection">Last Inspection</button>
      <button id="applyYM" class="btn">Apply</button>
    </div>
  </div>

  <div id="errBox" class="small" style="margin-top:8px;color:#9B2226;"></div>

  <section id="tiles" class="tiles"></section>

  <section class="section">
    <div class="sec-title">Photos (Selected Year/Month)</div>
    <div id="photoSections"></div>
  </section>
</div>

<script>
/* === Your published CSV === */
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTH18JY92PQUibhQfTwhTcJZpEEuz-NrBbe4fUWAB0lSCT2tY-X9GwIVEQhr8XCHEH08EHfq3vav1Td/pub?output=csv';

/* === State === */
let RAW_ROWS = [];
let YEARS = [];
let MONTHS_BY_YEAR = {};
let LATEST_YM = {year: undefined, month: undefined};

/* === Header detection (EN + ES) === */
const TS_KEYS = [
  'Timestamp','timestamp','Marca temporal','marca temporal',
  'Fecha','fecha','Fecha y hora','fecha y hora','Datetime','Date','date'
];
/* Heuristics for photos */
const PHOTO_NAME_HINTS = ['photo','foto','imagen','image','picture','pic','fotos','photograph','screenshot'];

/* We will infer sections from headers like: [BR_1] - Question ... */
const SECTION_CODE_RE = /^\s*\[([^\]]+)\]/;

/* === UI helpers === */
function setError(msg){ document.getElementById('errBox').textContent = msg || ''; }
function firstDefinedIn(row, keys){
  for(const k of keys){
    if (k in row && row[k] != null && String(row[k]).trim() !== '') return row[k];
  }
  /* Fallback: look for any header that loosely matches "timestamp" or "fecha" */
  for (const key of Object.keys(row)){
    const lk = key.toLowerCase();
    if ((lk.includes('timestamp') || lk.includes('marca temporal') || lk === 'fecha' || lk.includes('fecha y hora')) && String(row[key]).trim() !== ''){
      return row[key];
    }
  }
  return undefined;
}
function getRowDate(row){
  const t = firstDefinedIn(row, TS_KEYS);
  const d = t ? new Date(t) : null;
  return (d && !isNaN(d)) ? d : null;
}
function deriveYearMonth(row){
  const d = getRowDate(row);
  return d ? {year:d.getFullYear(), month:d.getMonth()+1} : {year:undefined, month:undefined};
}
function monthName(m){ return new Date(2000, m-1, 1).toLocaleString(undefined,{month:'long'}); }
function isUrl(v){ const s = String(v||'').trim(); return /^https?:\/\//i.test(s); }

/* === Column metadata built once from headers === */
let COL_META = []; // [{key, sectionCode, isPhoto, isAnswerCandidate}]
function buildColMeta(headers){
  COL_META = headers.map(h=>{
    const key = h;
    const isPhoto = PHOTO_NAME_HINTS.some(w => h.toLowerCase().includes(w));
    let sectionCode = null;
    const m = h.match(SECTION_CODE_RE);
    if (m) sectionCode = m[1].trim(); // e.g. BR_1, GQ, LL, etc.
    // "Answer candidate": we will scan its values for Yes/Sí/No
    const isAnswerCandidate = !!sectionCode && !isPhoto;
    return {key, sectionCode, isPhoto, isAnswerCandidate};
  });
}

/* === Yes / No counting === */
function classifyAnswer(val){
  if (val == null) return 'ignore';
  const raw = String(val).trim();
  if (!raw) return 'ignore';
  if (isUrl(raw)) return 'ignore';               // links don't count
  const lc = raw.toLowerCase();
  if (lc === 'yes' || lc === 'sí' || lc === 'si') return 'pass';
  if (lc === 'no') return 'fail';
  return 'ignore';                                // comments, numbers, etc. ignored
}

/* === Aggregate by section for selected rows === */
function aggregateBySection(rows){
  const agg = { sections: {}, photos: {} };
  for (const row of rows){
    // Count answers per section
    for (const col of COL_META){
      const val = row[col.key];
      if (col.isAnswerCandidate){
        const cls = classifyAnswer(val);
        if (cls !== 'ignore'){
          if (!agg.sections[col.sectionCode]) agg.sections[col.sectionCode] = {passes:0, fails:0, total:0};
          if (cls === 'pass') agg.sections[col.sectionCode].passes++;
          if (cls === 'fail') agg.sections[col.sectionCode].fails++;
          agg.sections[col.sectionCode].total++;
        }
      }
      // Collect photos under the right section (if header had code), else "Misc"
      if (col.isPhoto && val){
        const urls = String(val).split(/\s+/).filter(isUrl);
        if (urls.length){
          const sec = col.sectionCode || 'Misc';
          if (!agg.photos[sec]) agg.photos[sec] = [];
          // date string (for captions)
          const d = getRowDate(row);
          const ts = d ? d.toISOString() : '';
          urls.forEach(u => agg.photos[sec].push({url:u, ts}));
        }
      }
    }
  }
  return agg;
}

/* === Render donut tiles === */
function renderTiles(agg){
  const tiles = document.getElementById('tiles');
  tiles.innerHTML = '';
  const secs = Object.keys(agg.sections).sort((a,b)=>String(a).localeCompare(String(b), undefined, {numeric:true}));
  if (!secs.length){
    tiles.innerHTML = '<div class="small">No sections detected for this period.</div>';
    return;
  }
  for (const sec of secs){
    const s = agg.sections[sec];
    const total = s.total || 0;
    const passes = s.passes || 0;
    const fails = s.fails || 0;
    const rate = total ? Math.round((passes/total)*100) : null;
    const pill = total === 0
      ? '<span class="pill na">No data</span>'
      : (fails>0 ? `<span class="pill bad">${fails} issue${fails>1?'s':''}</span>` : '<span class="pill ok">Clear</span>');
    const dash = rate===null ? '0,100' : `${rate},${100-rate}`;
    const center = rate===null ? 'No Data' : `${rate}%`;

    const tile = document.createElement('a');
    tile.className = 'tile';
    tile.href = '#sec-'+String(sec).replace(/\s+/g,'-').toLowerCase();
    tile.innerHTML = `
      <svg class="donut" viewBox="0 0 36 36" aria-hidden="true">
        <circle cx="18" cy="18" r="15.915" fill="none" stroke="#EAEFF5" stroke-width="3.8"></circle>
        <circle cx="18" cy="18" r="15.915" fill="none" stroke="#7A6C5D" stroke-width="3.8" stroke-linecap="round" stroke-dasharray="${dash}"></circle>
        <text x="18" y="20" text-anchor="middle">${center}</text>
      </svg>
      <div class="name">${sec}</div>
      ${pill}
    `;
    tiles.appendChild(tile);
  }
}

/* === Render photos section === */
function toDrivePreview(u){
  try{
    if(!u.includes('drive.google.com')) return null;
    const m = u.match(/\/file\/d\/([^/]+)\//);
    let id = m ? m[1] : null;
    if(!id){ const url = new URL(u); id = url.searchParams.get('id'); }
    return id ? ('https://drive.google.com/file/d/'+id+'/preview') : null;
  }catch(e){ return null; }
}
function renderPhotos(agg){
  const wrap = document.getElementById('photoSections');
  wrap.innerHTML = '';
  const secs = Object.keys(agg.photos).sort((a,b)=>String(a).localeCompare(String(b), undefined, {numeric:true}));
  if (!secs.length){
    wrap.innerHTML = '<div class="small">No photos for this period.</div>';
    return;
  }
  for (const sec of secs){
    const id='sec-'+String(sec).replace(/\s+/g,'-').toLowerCase();
    const secDiv=document.createElement('div'); secDiv.className='section'; secDiv.id=id;
    secDiv.innerHTML=`<div class="sec-title">${sec}</div>`;
    const g=document.createElement('div'); g.className='gallery';
    (agg.photos[sec]||[]).slice(0,100).forEach(item=>{
      const fig=document.createElement('figure'); fig.className='ph';
      const img=document.createElement('img'); img.alt=sec+' photo'; img.loading='lazy'; img.referrerPolicy='no-referrer'; img.src=item.url;
      img.onerror=()=>{
        const preview = toDrivePreview(item.url);
        if(preview){
          const ifr = document.createElement('iframe'); ifr.loading='lazy'; ifr.src=preview; fig.appendChild(ifr); img.remove();
        } else {
          const a=document.createElement('a'); a.href=item.url; a.target='_blank'; a.textContent='Open Photo'; img.replaceWith(a);
        }
      };
      const cap=document.createElement('figcaption');
      const left=document.createElement('span'); left.className='cap-left'; left.textContent=sec;
      const right=document.createElement('span'); right.className='cap-right'; right.textContent = item.ts ? (new Date(item.ts)).toLocaleString() : '';
      cap.appendChild(left); cap.appendChild(right);
      fig.appendChild(img); fig.appendChild(cap); g.appendChild(fig);
    });
    secDiv.appendChild(g); wrap.appendChild(secDiv);
  }
}

/* === Selectors & interactions === */
function populateSelectors(){
  const ySel = document.getElementById('year');
  const mSel = document.getElementById('month');
  ySel.innerHTML='';
  YEARS.forEach(y=>{
    const opt=document.createElement('option'); opt.value=y; opt.textContent=y; ySel.appendChild(opt);
  });
  if (YEARS.length) ySel.value = YEARS[YEARS.length-1];

  function fillMonths(y){
    mSel.innerHTML='';
    const months = (MONTHS_BY_YEAR[String(y)] || []).sort((a,b)=>a-b);
    months.forEach(m=>{
      const opt=document.createElement('option');
      opt.value=m;
      opt.textContent=monthName(m);
      mSel.appendChild(opt);
    });
    if(months.length){ mSel.value = months[months.length-1]; }
  }
  fillMonths(ySel.value);
  ySel.onchange = ()=>{ fillMonths(ySel.value); applyYearMonth(); };
  mSel.onchange = applyYearMonth;
}
function applyYearMonth(){
  const y = parseInt(document.getElementById('year').value,10);
  const m = parseInt(document.getElementById('month').value,10);
  const rows = RAW_ROWS.filter(r=>{ const d=deriveYearMonth(r); return d.year===y && d.month===m; });
  const agg = aggregateBySection(rows);
  const label = rows.length ? `${monthName(m)} ${y}` : 'No data';
  document.getElementById('summaryDate').textContent = label;
  renderTiles(agg);
  renderPhotos(agg);
}
function jumpToLast(){
  if (!LATEST_YM.year || !LATEST_YM.month) return;
  const ySel = document.getElementById('year');
  const mSel = document.getElementById('month');
  ySel.value = String(LATEST_YM.year);
  // ensure month list for selected year is in DOM
  const months = (MONTHS_BY_YEAR[String(LATEST_YM.year)] || []).sort((a,b)=>a-b);
  mSel.innerHTML='';
  months.forEach(m=>{
    const opt=document.createElement('option');
    opt.value=m; opt.textContent=monthName(m); mSel.appendChild(opt);
  });
  mSel.value = String(LATEST_YM.month);
  applyYearMonth();
}

/* === Fetch & index === */
async function fetchCSVRows(){
  const url = CSV_URL + (CSV_URL.includes('?') ? '&' : '?') + '_ts_=' + Date.now();
  let res;
  try{
    res = await fetch(url, { cache: 'no-store', mode: 'cors' });
  }catch(e){
    throw new Error('Network error: '+(e?.message||e));
  }
  if (!res.ok){
    let text=''; try{text=await res.text();}catch(e){}
    const hint = text ? (' Preview: '+text.slice(0,180).replace(/\s+/g,' ')) : '';
    throw new Error(`HTTP ${res.status} ${res.statusText}.${hint}`);
  }
  const text = await res.text();
  if (/^\s*<!doctype html>|<html[\s>]/i.test(text)) throw new Error('Got HTML instead of CSV. Make sure the link is a public CSV.');
  const parsed = Papa.parse(text, { header:true, dynamicTyping:false, skipEmptyLines:true });
  if (parsed.errors && parsed.errors.length){
    const e = parsed.errors[0]; throw new Error(`CSV parse error at row ${e.row ?? '?'}: ${e.message}`);
  }
  return parsed.data;
}
function buildYearMonthIndex(rows){
  const years = new Set();
  const monthsMap = {}; // {year: Set(months)}
  let latest = {ts:0, year:undefined, month:undefined};

  for (const r of rows){
    const d = getRowDate(r);
    if (!d) continue;
    const y = d.getFullYear(), m = d.getMonth()+1;
    years.add(y);
    if (!monthsMap[y]) monthsMap[y] = new Set();
    monthsMap[y].add(m);
    const t = +d;
    if (t > latest.ts) { latest = {ts:t, year:y, month:m}; }
  }
  YEARS = Array.from(years).sort((a,b)=>a-b);
  MONTHS_BY_YEAR = {};
  for (const y of YEARS){ MONTHS_BY_YEAR[y] = Array.from(monthsMap[y]).sort((a,b)=>a-b); }
  LATEST_YM = {year: latest.year, month: latest.month};
}

/* === Boot === */
async function loadAndRender(){
  setError(''); document.getElementById('summaryDate').textContent = 'Loading…';
  try{
    const rows = await fetchCSVRows();
    if (!rows.length){ throw new Error('CSV is empty.'); }

    // Build col metadata from headers
    const headers = Object.keys(rows[0] || {});
    buildColMeta(headers);

    // Save rows & index by dates
    RAW_ROWS = rows;
    buildYearMonthIndex(RAW_ROWS);

    // Populate UI and render initial month (latest by default)
    populateSelectors();
    if (LATEST_YM.year && LATEST_YM.month){
      document.getElementById('year').value = String(LATEST_YM.year);
      // fill month list for that year if needed
      const months = (MONTHS_BY_YEAR[String(LATEST_YM.year)] || []).sort((a,b)=>a-b);
      const mSel = document.getElementById('month');
      mSel.innerHTML='';
      months.forEach(m=>{
        const opt=document.createElement('option');
        opt.value=m; opt.textContent=monthName(m); mSel.appendChild(opt);
      });
      mSel.value = String(LATEST_YM.month);
    }
    applyYearMonth();
  }catch(err){
    console.error(err);
    setError(err.message);
    document.getElementById('summaryDate').textContent = 'Failed to load CSV';
    document.getElementById('tiles').innerHTML = '<div class="small">Could not load data.</div>';
    document.getElementById('photoSections').innerHTML = '';
  }
}

document.getElementById('applyYM').addEventListener('click', applyYearMonth);
document.getElementById('lastBtn').addEventListener('click', jumpToLast);
loadAndRender();
</script>
</body>
</html>
