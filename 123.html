<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Owner Inspection — Live CSV (with Diagnostics)</title>
<style>
:root{--bg:#fff;--ink:#111827;--muted:#6B7280;--line:#E5E7EB;--ok:#287271;--bad:#9B2226;--brand:#1F2937}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
.wrap{max-width:1200px;margin:0 auto;padding:20px}
.header{display:flex;flex-wrap:wrap;align-items:center;gap:12px;position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);padding:10px 0;z-index:10}
.h-title{font-weight:900;font-size:18px;color:var(--brand)}
.h-sub{color:var(--muted);font-size:12px}
.controls{display:flex;flex-wrap:wrap;gap:8px}
select,input,button{border:1px solid var(--line);border-radius:8px;padding:8px 10px;font-size:12px}
.btn{background:#fff;color:var(--brand);cursor:pointer}
.tiles{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:14px;margin-top:14px}
.tile{display:flex;flex-direction:column;align-items:center;border:1px solid var(--line);border-radius:12px;padding:12px;background:#fff;text-decoration:none;color:inherit}
.tile .name{font-weight:800;margin-top:6px}
.tile .pill{font-size:11px;margin-top:6px;padding:3px 7px;border-radius:999px;border:1px solid var(--line)}
.pill.ok{background:#ECFDF5;color:#065F46;border-color:#A7F3D0}
.pill.bad{background:#FEF2F2;color:#991B1B;border-color:#FECACA}
.pill.na{background:#F3F4F6;color:#374151;border-color:#E5E7EB}
.section{margin:18px 0}
.sec-title{font-weight:900;border-left:4px solid var(--brand);padding-left:10px;margin:6px 0 10px}
.gallery{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:8px}
.ph{margin:0;border:1px solid var(--line);border-radius:10px;overflow:hidden;background:#fff;position:relative}
.ph img,.ph iframe{width:100%;height:160px;object-fit:cover;display:block;border:0}
.ph figcaption{font-size:11px;color:#6B7280;padding:6px 8px;display:flex;justify-content:space-between;gap:6px}
.cap-left{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cap-right{color:#374151;white-space:nowrap}
.small{font-size:12px;color:var(--muted)}
.donut{width:72px;height:72px}
.tile svg text{font-size:6px;font-weight:800;fill:#111827}

/* Diagnostics panel */
.diag{margin-top:14px;border:1px dashed var(--line);border-radius:10px;padding:12px;background:#fafafa}
.diag h3{margin:0 0 8px 0;font-size:13px;color:#374151}
.diag .kv{display:flex;flex-wrap:wrap;gap:10px;margin:6px 0}
.diag .kv div{font-size:12px;background:#fff;border:1px solid var(--line);border-radius:6px;padding:6px 8px}
.diag table{width:100%;border-collapse:collapse;font-size:12px}
.diag th,.diag td{border-top:1px solid var(--line);padding:6px 8px;vertical-align:top}
.diag th{background:#fff;text-align:left}
</style>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div>
      <div class="h-title">Owner Inspection — Year / Month</div>
      <div class="h-sub small" id="summaryDate"></div>
    </div>
    <div class="controls">
      <select id="year" title="Year"></select>
      <select id="month" title="Month"></select>
      <button id="lastBtn" class="btn">Last Inspection</button>
      <button id="applyYM" class="btn">Apply</button>
    </div>
  </div>

  <div id="errBox" class="small" style="margin-top:8px;color:#9B2226;"></div>

  <!-- Diagnostics -->
  <div class="diag" id="diagBox" style="display:none">
    <h3>Data Preview & Detection</h3>
    <div class="kv">
      <div><b>Total rows:</b> <span id="diagRows">0</span></div>
      <div><b>Detected years:</b> <span id="diagYears">—</span></div>
      <div><b>Detected months per year:</b> <span id="diagMonths">—</span></div>
      <div><b>Distinct sections:</b> <span id="diagSections">—</span></div>
    </div>
    <div style="overflow:auto;max-height:260px">
      <table id="diagTable"><thead></thead><tbody></tbody></table>
    </div>
  </div>

  <section id="tiles" class="tiles"></section>
  <section class="section">
    <div class="sec-title">Photos (Selected Year/Month)</div>
    <div id="photoSections"></div>
  </section>
</div>

<script>
/* ====== CONFIG: your published CSV ====== */
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTH18JY92PQUibhQfTwhTcJZpEEuz-NrBbe4fUWAB0lSCT2tY-X9GwIVEQhr8XCHEH08EHfq3vav1Td/pub?output=csv';

/* ====== STATE ====== */
let RAW_ROWS = [], YEARS = [], MONTHS_BY_YEAR = {}, LATEST_YM = {year:undefined,month:undefined};

/* ====== Headings we understand (EN + ES) ====== */
const TS_KEYS = ['timestamp','Timestamp','TS','ts','Marca temporal','marca temporal','Fecha','fecha','Fecha y hora','fecha y hora','Datetime','Date'];
const YEAR_KEYS = ['year','Year','YEAR','Año','año'];
const MONTH_KEYS = ['month','Month','MONTH','Mes','mes'];
const SECTION_KEYS = ['section','Section','SECTION','Sección','sección'];
const PASS_KEYS = ['passes','pass','Passes','PASS','PASSes'];
const FAIL_KEYS = ['fails','fail','Fails','FAIL'];
const TOTAL_KEYS = ['total','Total','TOTAL'];
const PHOTO_URL_KEYS = ['photo_url','photo','Photo','URL','url','Foto','foto','Imagen','imagen'];
const PHOTO_TS_KEYS = ['photo ts','photo_ts','photo timestamp','Marca temporal','fecha','timestamp','ts','Timestamp','TS'];

/* Keys we skip when scanning for Yes/Sí/No answers */
const META_KEYS = new Set([
  ...TS_KEYS, ...YEAR_KEYS, ...MONTH_KEYS, ...SECTION_KEYS,
  ...PASS_KEYS, ...FAIL_KEYS, ...TOTAL_KEYS, ...PHOTO_URL_KEYS, ...PHOTO_TS_KEYS
]);

/* ====== Utils ====== */
function setError(msg){ document.getElementById('errBox').textContent = msg || ''; }
function toNum(v){ const n = Number(v); return Number.isFinite(n) ? n : 0; }
function firstDefinedIn(row, keys){
  for (const k of keys){ if (row[k] != null && String(row[k]).trim() !== '') return row[k]; }
  return undefined;
}

/* Try to get year/month explicitly, else derive from timestamp */
function deriveYearMonth(row){
  const y = firstDefinedIn(row, YEAR_KEYS);
  const m = firstDefinedIn(row, MONTH_KEYS);
  if (y && m) return {year: +y, month: +m};
  const t = firstDefinedIn(row, TS_KEYS) || firstDefinedIn(row, PHOTO_TS_KEYS);
  const d = t ? new Date(t) : null;
  return d && !isNaN(d) ? {year: d.getFullYear(), month: d.getMonth()+1} : {year: undefined, month: undefined};
}

/* Count Yes/Sí = pass; No = fail; ignore blanks/comments/links */
function computeYNCounts(row){
  let pass=0, fail=0;
  for (const [k,v] of Object.entries(row)){
    if (META_KEYS.has(k)) continue;
    if (v == null) continue;
    const raw = String(v).trim();
    if (!raw) continue;
    if (raw.includes('http://') || raw.includes('https://')) continue;
    const lc = raw.toLowerCase();
    if (lc === 'yes' || lc === 'sí' || lc === 'si'){ pass++; continue; }
    if (lc === 'no'){ fail++; continue; }
    // other text -> treat as comment, ignore
  }
  return {passes: pass, fails: fail, total: pass + fail};
}

/* ====== Aggregation & Rendering ====== */
function aggregateFromRows(rows){
  const agg={overall:{total:0,passes:0,fails:0,rate:0}, sections:{}, photos:{}};
  rows.forEach(r=>{
    const section = firstDefinedIn(r, SECTION_KEYS);
    let passes = toNum(firstDefinedIn(r, PASS_KEYS));
    let fails  = toNum(firstDefinedIn(r, FAIL_KEYS));
    let total  = toNum(firstDefinedIn(r, TOTAL_KEYS));
    if ((passes + fails) === 0 && total === 0){
      const c = computeYNCounts(r);
      passes = c.passes; fails = c.fails; total = c.total;
    }
    if (!total) total = passes + fails;

    if (section){
      if(!agg.sections[section]) agg.sections[section]={total:0,passes:0,fails:0};
      agg.sections[section].total += total;
      agg.sections[section].passes += passes;
      agg.sections[section].fails  += fails;
    }

    agg.overall.total  += total;
    agg.overall.passes += passes;
    agg.overall.fails  += fails;

    const purl = firstDefinedIn(r, PHOTO_URL_KEYS);
    const pts  = firstDefinedIn(r, PHOTO_TS_KEYS) || firstDefinedIn(r, TS_KEYS) || new Date().toISOString();
    if (purl && section){
      if(!agg.photos[section]) agg.photos[section]=[];
      agg.photos[section].push({url:purl, ts:pts});
    }
  });
  agg.overall.rate = agg.overall.total ? (agg.overall.passes/agg.overall.total*100) : 0;
  return agg;
}

function renderTiles(agg){
  const tiles=document.getElementById('tiles');
  tiles.innerHTML='';
  const secs=Object.keys(agg.sections).sort();
  if (!secs.length){
    tiles.innerHTML = `<div class="small">No sections detected. Make sure your CSV has a column named one of: <code>${SECTION_KEYS.join('</code>, <code>')}</code>.</div>`;
    return;
  }
  secs.forEach(sec=>{
    const s=agg.sections[sec];
    const total = s.total || 0;
    const passes = s.passes || 0;
    const fails  = s.fails  || 0;
    const rate = total ? Math.round((passes/total)*100) : null; // null => No Data
    const pill = total === 0
      ? '<span class="pill na">No data</span>'
      : (fails>0 ? `<span class="pill bad">${fails} issue${fails>1?'s':''}</span>` : '<span class="pill ok">Clear</span>');
    const dash = rate===null ? '0,100' : rate+','+(100-rate);
    const center = rate===null ? 'No Data' : (rate+'%');

    const tile=document.createElement('a'); tile.className='tile'; tile.href='#sec-'+sec.replace(/\s+/g,'-').toLowerCase();
    tile.innerHTML=`
      <svg class="donut" viewBox="0 0 36 36">
        <circle cx="18" cy="18" r="15.915" fill="none" stroke="#EAEFF5" stroke-width="3.8"></circle>
        <circle cx="18" cy="18" r="15.915" fill="none" stroke="#7A6C5D" stroke-width="3.8" stroke-linecap="round" stroke-dasharray="${dash}"></circle>
        <text x="18" y="20" text-anchor="middle">${center}</text>
      </svg>
      <div class="name">${sec}</div>
      ${pill}`;
    tiles.appendChild(tile);
  });
}

function toDrivePreview(u){
  try{
    if(!u.includes('drive.google.com')) return null;
    const m = u.match(/\/file\/d\/([^/]+)\//);
    let id = m ? m[1] : null;
    if(!id){ const url = new URL(u); id = url.searchParams.get('id'); }
    return id ? ('https://drive.google.com/file/d/'+id+'/preview') : null;
  }catch(e){ return null; }
}

function renderPhotos(agg){
  const wrap=document.getElementById('photoSections');
  wrap.innerHTML='';
  const secs=Object.keys(agg.photos).sort();
  secs.forEach(sec=>{
    const id='sec-'+sec.replace(/\s+/g,'-').toLowerCase();
    const secDiv=document.createElement('div'); secDiv.className='section'; secDiv.id=id;
    secDiv.innerHTML=`<div class="sec-title">${sec}</div>`;
    const g=document.createElement('div'); g.className='gallery';
    (agg.photos[sec]||[]).slice(0,60).forEach(item=>{
      const url = item.url, ts = item.ts;
      const fig=document.createElement('figure'); fig.className='ph';
      const img=document.createElement('img'); img.alt=sec+' photo'; img.loading='lazy'; img.referrerPolicy='no-referrer'; img.src=url;
      img.onerror=()=>{
        const preview = toDrivePreview(url);
        if(preview){
          const ifr = document.createElement('iframe'); ifr.loading='lazy'; ifr.src=preview; fig.appendChild(ifr);
          img.remove();
        } else {
          const a=document.createElement('a'); a.href=url; a.target='_blank'; a.textContent='Open Photo'; img.replaceWith(a);
        }
      };
      const cap=document.createElement('figcaption');
      const left=document.createElement('span'); left.className='cap-left'; left.textContent=sec;
      const right=document.createElement('span'); right.className='cap-right'; right.textContent = (new Date(ts)).toLocaleString();
      cap.appendChild(left); cap.appendChild(right);
      fig.appendChild(img); fig.appendChild(cap); g.appendChild(fig);
    });
    secDiv.appendChild(g); wrap.appendChild(secDiv);
  });
}

/* ====== UI plumbing ====== */
function populateSelectors(){
  const ySel = document.getElementById('year');
  const mSel = document.getElementById('month');
  ySel.innerHTML='';
  YEARS.forEach(y=>{
    const opt=document.createElement('option'); opt.value=y; opt.textContent=y; ySel.appendChild(opt);
  });
  if (YEARS.length) ySel.value = YEARS[YEARS.length-1];

  function fillMonths(y){
    mSel.innerHTML='';
    const months = (MONTHS_BY_YEAR[String(y)] || []).sort((a,b)=>a-b);
    months.forEach(m=>{
      const opt=document.createElement('option');
      opt.value=m;
      const name=new Date(2000,m-1,1).toLocaleString(undefined,{month:'long'});
      opt.textContent=name;
      mSel.appendChild(opt);
    });
    if(months.length){ mSel.value = months[months.length-1]; }
  }
  fillMonths(ySel.value);
  ySel.addEventListener('change', ()=>{ fillMonths(ySel.value); applyYearMonth(); });
  mSel.addEventListener('change', applyYearMonth);
}

function applyYearMonth(){
  const y = parseInt(document.getElementById('year').value,10);
  const m = parseInt(document.getElementById('month').value,10);
  const rows = RAW_ROWS.filter(r=>{
    const d = deriveYearMonth(r);
    return d.year===y && d.month===m;
  });
  const agg = aggregateFromRows(rows);

  const label = rows.length
    ? new Date(y, m-1, 1).toLocaleString(undefined,{year:'numeric',month:'long'})
    : 'No data';
  document.getElementById('summaryDate').textContent = label;

  renderTiles(agg);
  renderPhotos(agg);
}

/* Jump to latest inspection by timestamp or newest year-month */
function jumpToLastInspection(){
  if (!LATEST_YM.year || !LATEST_YM.month) return;
  const ySel = document.getElementById('year');
  const mSel = document.getElementById('month');
  ySel.value = String(LATEST_YM.year);
  // rebuild month list for selected year
  const months = (MONTHS_BY_YEAR[String(LATEST_YM.year)] || []).sort((a,b)=>a-b);
  mSel.innerHTML='';
  months.forEach(m=>{
    const opt=document.createElement('option');
    opt.value=m;
    const name=new Date(2000,m-1,1).toLocaleString(undefined,{month:'long'});
    opt.textContent=name;
    mSel.appendChild(opt);
  });
  mSel.value = String(LATEST_YM.month);
  applyYearMonth();
}

/* ====== Fetch & Index with Diagnostics ====== */
async function fetchCSVRows(){
  const fetchUrl = CSV_URL + (CSV_URL.includes('?') ? '&' : '?') + '_ts_=' + Date.now();
  let res;
  try{
    res = await fetch(fetchUrl, { cache: 'no-store', mode: 'cors' });
  }catch(networkErr){
    throw new Error('Network error: ' + (networkErr && networkErr.message ? networkErr.message : String(networkErr)));
  }
  if(!res.ok){
    let text=''; try { text = await res.text(); } catch(e){}
    const snippet = text ? (' Response preview: ' + text.slice(0, 200).replace(/\s+/g,' ')) : '';
    throw new Error(`HTTP ${res.status} ${res.statusText}.${snippet}`);
  }
  const text = await res.text();
  if (/^\s*<!doctype html>|<html[\s>]/i.test(text)) {
    throw new Error('Got HTML instead of CSV — check the link is a published CSV.');
  }
  const parsed = Papa.parse(text, { header: true, dynamicTyping: false, skipEmptyLines: true });
  if (parsed.errors && parsed.errors.length){
    const e = parsed.errors[0];
    throw new Error(`CSV parse error at row ${e.row ?? '?'}: ${e.message}`);
  }
  return parsed.data;
}

function buildYearMonthIndex(rows){
  const years = new Set();
  const map = {};
  let latest = {year: undefined, month: undefined, ts: 0};

  rows.forEach(r=>{
    const {year, month} = deriveYearMonth(r);
    if(!year || !month) return;
    years.add(year);
    const key = String(year);
    if(!map[key]) map[key] = new Set();
    map[key].add(month);

    const tStr = firstDefinedIn(r, TS_KEYS) || firstDefinedIn(r, PHOTO_TS_KEYS);
    const t = tStr ? Date.parse(tStr) : Date.parse(`${year}-${String(month).padStart(2,'0')}-01`);
    if (!Number.isNaN(t) && t > latest.ts){
      latest = {year, month, ts: t};
    }
  });

  YEARS = Array.from(years).sort((a,b)=>a-b);
  MONTHS_BY_YEAR = {};
  Object.entries(map).forEach(([y, set])=>{
    MONTHS_BY_YEAR[y] = Array.from(set).sort((a,b)=>a-b);
  });
  LATEST_YM = {year: latest.year, month: latest.month};
}

/* ====== Diagnostics UI ====== */
function renderDiagnostics(rows){
  const box = document.getElementById('diagBox');
  const tHead = document.querySelector('#diagTable thead');
  const tBody = document.querySelector('#diagTable tbody');
  box.style.display = 'block';

  // Row count
  document.getElementById('diagRows').textContent = String(rows.length);

  // Years / months summary
  const yrText = YEARS.length ? YEARS.join(', ') : '—';
  document.getElementById('diagYears').textContent = yrText;

  const monthsSummary = YEARS.map(y=>{
    const ms = (MONTHS_BY_YEAR[String(y)] || []).sort((a,b)=>a-b);
    const names = ms.map(m=>new Date(2000,m-1,1).toLocaleString(undefined,{month:'short'})).join(' ');
    return `${y}: [${names}]`;
  }).join('  ');
  document.getElementById('diagMonths').textContent = monthsSummary || '—';

  // Distinct sections
  const sections = new Set();
  rows.forEach(r=>{
    const s = firstDefinedIn(r, SECTION_KEYS);
    if (s) sections.add(s);
  });
  document.getElementById('diagSections').textContent = sections.size ? Array.from(sections).sort().join(', ') : '—';

  // First 5 rows preview
  tHead.innerHTML=''; tBody.innerHTML='';
  if (!rows.length) return;
  const cols = Object.keys(rows[0]);
  const tr = document.createElement('tr');
  cols.forEach(c=>{
    const th=document.createElement('th'); th.textContent=c; tr.appendChild(th);
  }); tHead.appendChild(tr);
  rows.slice(0,5).forEach(r=>{
    const tr=document.createElement('tr');
    cols.forEach(c=>{
      const td=document.createElement('td'); td.textContent = r[c]; tr.appendChild(td);
    });
    tBody.appendChild(tr);
  });
}

/* ====== Boot ====== */
async function loadAndRender(){
  setError(''); document.getElementById('summaryDate').textContent = 'Loading…';
  try{
    RAW_ROWS = await fetchCSVRows();
    buildYearMonthIndex(RAW_ROWS);
    populateSelectors();
    applyYearMonth();
    renderDiagnostics(RAW_ROWS);
    setError('');
  }catch(err){
    console.error(err);
    setError(err.message);
    document.getElementById('summaryDate').textContent = 'Failed to load CSV';
    document.getElementById('tiles').innerHTML = '<div class="small">Could not load data.</div>';
    document.getElementById('photoSections').innerHTML = '';
    document.getElementById('diagBox').style.display='block';
  }
}

document.getElementById('applyYM').addEventListener('click', applyYearMonth);
document.getElementById('lastBtn').addEventListener('click', jumpToLastInspection);
loadAndRender();
</script>
</body>
</html>
