<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Property Finder</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- Framer Motion -->
  <script src="https://cdn.jsdelivr.net/npm/framer-motion/dist/framer-motion.umd.js"></script>
  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- React & ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <!-- Babel for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    html { font-family: Inter, ui-sans-serif, system-ui, -apple-system; }
  </style>
</head>
<body class="bg-gray-50">
  <div id="root"></div>

  <script type="text/babel">
    // === CONFIG ===
    const PUBLISHED_SHEET_HTML = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTKgz7pmoBf2cO2hZ_6qwJh7vHa6RCGxP9277_bHyZyl1wZv1WSQtMP8BnBb-K_wlVs69v9P-JwR6Jj/pubhtml";
    
    const { useState, useEffect, useMemo, useRef } = React;

    // Utility functions
    const tryBuildCsvUrl = (htmlUrl) => {
      try {
        const u = new URL(htmlUrl);
        const base = u.toString().replace(/\/pubhtml(?:\?.*)?$/, "/pub");
        return base + "?output=csv&single=true";
      } catch { return null; }
    };
    const currency = (n) => isNaN(n) ? "—" : `$${Number(n).toLocaleString()}`;
    const parseNumber = (v) => {
      const s = String(v || "").replace(/[^0-9.]/g, "");
      return s ? Number(s) : null;
    };
    const norm = (s) => (s ? String(s).trim() : "");

    const detectColumns = (headers) => {
      const keys = headers.map((h) => h.toLowerCase());
      const find = (...names) => {
        for (let n of names) {
          let idx = keys.findIndex(k => k.includes(n));
          if (idx !== -1) return headers[idx];
        }
        return null;
      };
      return {
        image: find("image","photo","img"),
        title: find("title","name","listing"),
        price: find("price","rent","cost"),
        beds: find("bed"),
        baths: find("bath"),
        city: find("city","neighborhood"),
        address: find("address","street"),
        link: find("link","url"),
        sqft: find("sqft","square")
      };
    };

    // Hook: load data
    function useSheetData(sheetHtmlUrl) {
      const [data, setData] = useState([]);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);

      const load = async () => {
        setLoading(true);
        try {
          let rows = [];
          const csvUrl = tryBuildCsvUrl(sheetHtmlUrl);
          if (csvUrl) {
            const res = await fetch(csvUrl);
            const text = await res.text();
            rows = Papa.parse(text, { header: true, skipEmptyLines: true }).data;
          }
          setData(rows.filter(r => Object.values(r).some(v => String(v).trim() !== "")));
        } catch (e) {
          setError(e.toString());
        } finally {
          setLoading(false);
        }
      };
      useEffect(() => { load(); }, [sheetHtmlUrl]);
      return { data, loading, error, reload: load };
    }

    // Card component
    function Card({ item }) {
      const { priceN, bedsN, bathsN, cityS, titleS, addrS, linkS, imgS, sqftN } = item;
      return (
        <div className="rounded-xl border bg-white shadow hover:shadow-lg overflow-hidden">
          <div className="relative aspect-[16/10] bg-gray-100">
            {imgS ? <img src={imgS} alt={titleS} className="w-full h-full object-cover"/> : null}
          </div>
          <div className="p-4">
            <div className="flex justify-between items-start">
              <h3 className="font-semibold">{titleS || addrS || cityS}</h3>
              {priceN && <span className="bg-black text-white text-xs rounded-full px-2 py-0.5">{currency(priceN)}</span>}
            </div>
            <p className="text-sm text-gray-500">{[addrS, cityS].filter(Boolean).join(" · ")}</p>
            <div className="flex gap-2 mt-2 text-xs text-gray-600">
              {bedsN && <span>{bedsN} beds</span>}
              {bathsN && <span>{bathsN} baths</span>}
              {sqftN && <span>{sqftN} sqft</span>}
            </div>
            {linkS && <a href={linkS} target="_blank" className="text-blue-600 text-sm mt-2 inline-block">View Listing</a>}
          </div>
        </div>
      );
    }

    // App
    function App() {
      const { data, loading, error } = useSheetData(PUBLISHED_SHEET_HTML);
      const headers = useMemo(() => (data[0] ? Object.keys(data[0]) : []), [data]);
      const cols = useMemo(() => detectColumns(headers), [headers]);

      const processed = useMemo(() => {
        return data.map(r => ({
          priceN: parseNumber(cols.price && r[cols.price]),
          bedsN: parseNumber(cols.beds && r[cols.beds]),
          bathsN: parseNumber(cols.baths && r[cols.baths]),
          cityS: norm(cols.city && r[cols.city]),
          titleS: norm(cols.title && r[cols.title]),
          addrS: norm(cols.address && r[cols.address]),
          linkS: norm(cols.link && r[cols.link]),
          imgS: norm(cols.image && r[cols.image]),
          sqftN: parseNumber(cols.sqft && r[cols.sqft])
        }));
      }, [data, cols]);

      return (
        <div className="max-w-6xl mx-auto p-4">
          <h1 className="text-2xl font-bold mb-4">Property Finder</h1>
          {loading && <p>Loading...</p>}
          {error && <p className="text-red-600">{error}</p>}
          <div className="grid gap-4 grid-cols-1 sm:grid-cols-2 md:grid-cols-3">
            {processed.map((p, i) => <Card key={i} item={p} />)}
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
